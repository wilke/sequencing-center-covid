#! /usr/bin/env sh

# Exit on any error
set -e

# Check if required arguments are provided
if [ $# -lt 2 ]; then
    echo "ERROR: Missing required arguments"
    echo "Usage: $0 <directory> <primer> [freyja_version]"
    echo "Example: $0 /path/to/run qiagen 2.0.0"
    exit 1
fi

dir=`basename $1`

# Validate directory path
if [ ! -d "$1" ]; then
    echo "ERROR: Directory '$1' does not exist"
    exit 1
fi

primer=$2

# Optional Freyja version parameter (backward compatible)
# Priority: CLI argument > FREYJA_VERSION env var > "latest" default
freyja_version=${3:-${FREYJA_VERSION:-latest}}

if [ "$primer" = "qiagen" ]
then
        echo Setting primer to ${primer}
elif [ "$primer" = "swift" ]
then
        echo Setting primer to ${primer}
elif [ "$primer" = "midnight" ]
then
        echo Setting primer to ${primer}
else
        echo "No primer specified. Usage: $0 <dir> <primer> [freyja_version]"
        echo "Primers: qiagen, swift, midnight"
        echo "Example: $0 /path/to/run swift 2.0.0-09_08_2025-00-34-2025-09-08"
        exit 1
fi

# Validate Freyja version exists
freyja_container="/local/incoming/covid/config/freyja_${freyja_version}.sif"
if [ ! -f "${freyja_container}" ]; then
        echo "ERROR: Freyja version '${freyja_version}' not found at ${freyja_container}"
        echo "Available versions:"
        ls -1 /local/incoming/covid/config/freyja_*.sif 2>/dev/null | sed 's/.*freyja_/  - /' | sed 's/.sif//'
        exit 1
fi

echo "Starting pipeline `date`"
echo "Creating $dir"
echo "Using Freyja version: ${freyja_version}"

covid_run_dir=/local/incoming/covid/runs/${dir}/
export_dir=/vol/sars2/jdavis/Sarah/
ssh_id_file=/local/incoming/covid/config/covid_rsa
rsa_file=covid_`whoami`_rsa

# Create infrastructure
mkdir /local/incoming/covid/runs/${dir}
for d in variants output depth bam samples staging ; do echo Creating ${dir}/${d}; mkdir -p ${covid_run_dir}/${d} ; done
cp /local/incoming/covid/config/Makefile  ${covid_run_dir}
cp /local/incoming/covid/config/MN908947.3.trimmed.fa ${covid_run_dir}

current_dir=`pwd`
cd ${covid_run_dir}
ln -s samples reads
cd ${current_dir}

# Copy files
echo "Copying fastq's"
find $1 -name "*.fastq.gz" -exec cp {} ${covid_run_dir}/samples/ \;
find $1 -name "*.sample-mapping.tsv" -exec cp {} ${covid_run_dir}/ \;
echo Found `ls ${covid_run_dir}/samples/ | wc -l` sequence files

# Assembly
echo "sh /local/incoming/covid/scripts/assembly.sh ${covid_run_dir} ${primer}"
sh /local/incoming/covid/scripts/assembly.sh ${covid_run_dir} ${primer}

# Export version for process-run.sh and Makefile to use
export FREYJA_VERSION=${freyja_version}
echo "FREYJA_VERSION=${freyja_version} sh /local/incoming/covid/scripts/process-run.sh ${covid_run_dir}"
sh /local/incoming/covid/scripts/process-run.sh ${covid_run_dir}

# Create plots
# echo Creating plots `date`
# prefix=`date +%y%m%d-%H%M`
# cd /local/incoming/covid/aggregate
# time make -i -j 20 plots > ${prefix}.plotting.out 2> ${prefix}.plotting.error 
# mkdir -p /local/incoming/covid/aggregate/${prefix}
# cp -r /local/incoming/covid/aggregate/current/* /local/incoming/covid/aggregate/${prefix}/
echo "Done pipeline `date`"
echo "Freyja version used: ${freyja_version}"
